name: all-in-one

on:
  workflow_call:
    inputs:
      name:
        description: "Package name"
        required: true
        type: string
      deps:
        description: "Comma-separated package deps"
        required: false
        type: string
      targets:
        description: "OS build targets"
        required: false
        default: '["ubuntu-latest", "macos-latest"]'
        type: string
      publish_to:
        description: "Package managers to publish to"
        required: false
        default: "deb,apk,pacman,rpm,macos"
        type: string
      repo_name:
        description: "Repository name for pacman and RPM"
        required: false
        default: "ttypt"
        type: string
    secrets:
      HOST:
        required: true
      USER:
        required: true
      SSH_KEY:
        required: true
      GPG_PRIVATE_KEY:
        required: false
      GPG_PASSPHRASE:
        required: false
      GPG_KEYID:
        required: false
      ABUILD_PRIVATE_KEY:
        required: false
      ABUILD_PUBLIC_KEY:
        required: false

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: ${{ fromJSON(inputs.targets) }}
    steps:
      - uses: tty-pt/ci/package@main
        with:
          name: ${{ inputs.name }}
          deps: ${{ inputs.deps }}
          publish_to: ${{ inputs.publish_to }}

  publish:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Determine which artifacts exist
        id: artifacts
        run: |
          # Create a map of which OS builds actually ran
          BUILT_TARGETS=""
          for os in ${{ join(fromJSON(inputs.targets), ' ') }}; do
            echo "Checking if $os was built..."
            BUILT_TARGETS="$BUILT_TARGETS $os"
          done
          echo "built_targets=$BUILT_TARGETS" >> $GITHUB_OUTPUT
          
          # Also set individual flags for each OS
          if [[ " $BUILT_TARGETS " == *" ubuntu-latest "* ]]; then
            echo "linux_built=true" >> $GITHUB_OUTPUT
          fi
          if [[ " $BUILT_TARGETS " == *" macos-latest "* ]]; then
            echo "macos_built=true" >> $GITHUB_OUTPUT
          fi
          if [[ " $BUILT_TARGETS " == *" windows-latest "* ]]; then
            echo "windows_built=true" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: Download Linux artifacts
        if: steps.artifacts.outputs.linux_built == 'true'
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.name }}-Linux
          path: dist-linux

      - name: Download macOS artifacts
        if: steps.artifacts.outputs.macos_built == 'true'
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.name }}-macOS
          path: dist-macos

      - name: Download Windows artifacts
        if: steps.artifacts.outputs.windows_built == 'true'
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.name }}-Windows
          path: dist-windows

      - name: Verify downloaded artifacts
        run: |
          echo "=== Downloaded Artifacts ==="
          echo "Linux:"
          ls -la dist-linux/ 2>/dev/null || echo "No Linux artifacts (not built or not found)"
          echo ""
          echo "macOS:"
          ls -la dist-macos/ 2>/dev/null || echo "No macOS artifacts (not built or not found)"
          echo ""
          echo "Windows:"
          ls -la dist-windows/ 2>/dev/null || echo "No Windows artifacts (not built or not found)"
        shell: bash

      - name: Publish to APT
        if: contains(inputs.publish_to, 'deb') && steps.artifacts.outputs.linux_built == 'true'
        uses: tty-pt/ci/publish-apt@main
        with:
          source: dist-linux/deb/*.deb
          host: ${{ secrets.HOST }}
          user: ${{ secrets.USER }}
          ssh_key: ${{ secrets.SSH_KEY }}
          gpg_key: ${{ secrets.GPG_PRIVATE_KEY }}
          gpg_pass: ${{ secrets.GPG_PASSPHRASE }}
          gpg_keyid: ${{ secrets.GPG_KEYID }}

      - name: Publish to APK
        if: contains(inputs.publish_to, 'apk') && steps.artifacts.outputs.linux_built == 'true'
        uses: tty-pt/ci/publish-apk@main
        with:
          source: dist-linux/apk/*.apk
          host: ${{ secrets.HOST }}
          user: ${{ secrets.USER }}
          ssh_key: ${{ secrets.SSH_KEY }}
          gpg_key: ${{ secrets.GPG_PRIVATE_KEY }}
          gpg_pass: ${{ secrets.GPG_PASSPHRASE }}
          gpg_keyid: ${{ secrets.GPG_KEYID }}

      - name: Publish to Pacman
        if: contains(inputs.publish_to, 'pacman') && steps.artifacts.outputs.linux_built == 'true'
        uses: tty-pt/ci/publish-pacman@main
        with:
          source: dist-linux/pacman/*.pkg.tar.*
          host: ${{ secrets.HOST }}
          user: ${{ secrets.USER }}
          ssh_key: ${{ secrets.SSH_KEY }}
          gpg_key: ${{ secrets.GPG_PRIVATE_KEY }}
          gpg_pass: ${{ secrets.GPG_PASSPHRASE }}
          gpg_keyid: ${{ secrets.GPG_KEYID }}
          repo_name: ${{ inputs.repo_name }}

      - name: Publish to RPM
        if: contains(inputs.publish_to, 'rpm') && steps.artifacts.outputs.linux_built == 'true'
        uses: tty-pt/ci/publish-rpm@main
        with:
          source: dist-linux/rpm/*.rpm
          host: ${{ secrets.HOST }}
          user: ${{ secrets.USER }}
          ssh_key: ${{ secrets.SSH_KEY }}
          gpg_key: ${{ secrets.GPG_PRIVATE_KEY }}
          gpg_pass: ${{ secrets.GPG_PASSPHRASE }}
          gpg_keyid: ${{ secrets.GPG_KEYID }}
          repo_name: ${{ inputs.repo_name }}

      - name: Publish to macOS
        if: contains(inputs.publish_to, 'macos') && steps.artifacts.outputs.macos_built == 'true'
        uses: tty-pt/ci/publish-macos@main
        with:
          source: dist-macos/*
          host: ${{ secrets.HOST }}
          user: ${{ secrets.USER }}
          ssh_key: ${{ secrets.SSH_KEY }}
          gpg_key: ${{ secrets.GPG_PRIVATE_KEY }}
          gpg_pass: ${{ secrets.GPG_PASSPHRASE }}
          gpg_keyid: ${{ secrets.GPG_KEYID }}

  package-any-deb:
    if: contains(inputs.publish_to, 'deb')
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/tty-pt/ubuntu-builder:latest
    steps:
    - name: Package APT
      uses: tty-pt/ci/package-any@main
      with:
        name: ${{ inputs.name }}
        format: 'deb'
        deps: ${{ inputs.deps }}
        gpg_key: ${{ secrets.GPG_PRIVATE_KEY }}
        gpg_pass: ${{ secrets.GPG_PASSPHRASE }}
        gpg_keyid: ${{ secrets.GPG_KEYID }}

  package-any-apk:
    if: contains(inputs.publish_to, 'apk')
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/tty-pt/alpine-builder:latest
    steps:
    - name: Package APK
      uses: tty-pt/ci/package-any@main
      with:
        name: ${{ inputs.name }}
        format: 'apk'
        deps: ${{ inputs.deps }}
        abuild_key: ${{ secrets.ABUILD_PRIVATE_KEY }}
        abuild_pub: ${{ secrets.ABUILD_PUBLIC_KEY }}

  package-any-pacman:
    if: contains(inputs.publish_to, 'pacman')
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/tty-pt/arch-builder:latest
    steps:
    - name: Package PACMAN
      uses: tty-pt/ci/package-any@main
      with:
        name: ${{ inputs.name }}
        format: 'pacman'
        ext: 'pkg.tar.zst'
        deps: ${{ inputs.deps }}
        gpg_key: ${{ secrets.GPG_PRIVATE_KEY }}
        gpg_pass: ${{ secrets.GPG_PASSPHRASE }}
        gpg_keyid: ${{ secrets.GPG_KEYID }}

  package-any-rpm:
    if: contains(inputs.publish_to, 'rpm')
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/tty-pt/rocky-builder:latest
    steps:
    - name: Package RPM
      uses: tty-pt/ci/package-any@main
      with:
        name: ${{ inputs.name }}
        format: 'rpm'
        deps: ${{ inputs.deps }}
        gpg_key: ${{ secrets.GPG_PRIVATE_KEY }}
        gpg_pass: ${{ secrets.GPG_PASSPHRASE }}
        gpg_keyid: ${{ secrets.GPG_KEYID }}

  release:
    runs-on: ubuntu-latest
    needs:
      - package-any-pacman
      - package-any-rpm
      - package-any-apk
      - package-any-deb
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release/
      
      - name: Create and publish GitHub Release
        uses: tty-pt/ci/release@main

  itest-rpm:
    if: contains(inputs.publish_to, 'rpm')
    needs: publish
    runs-on: ubuntu-latest
    container:
      image: rockylinux:9
    steps:
    - name: Test install
      uses: tty-pt/ci/itest-rpm@main
      with:
        name: ${{ inputs.name }}
